name: cd.yml

on:
  push:
    branches:
      - feat/234-infra-sentry

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      NCR_REGISTRY: ${{ secrets.NCP_CR_ENDPOINT }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 표준 방식으로 pnpm 실행 파일을 보장합니다.
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # ----------------------------------------------------------------
      # [Backend] Build & Upload Sourcemaps
      # ----------------------------------------------------------------
      - name: Build Backend (for sourcemaps)
        run: pnpm turbo run build --filter=backend

      - name: Upload Backend Sourcemaps to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT_BACKEND }}
          SENTRY_RELEASE: backend@${{ github.sha }}
        run: |
          if [ ! -d "apps/backend/dist" ]; then
            echo "[sentry] apps/backend/dist not found. Skipping upload."
            exit 0
          fi

          MAP_COUNT=$(find apps/backend/dist -name '*.map' | wc -l | tr -d ' ')
          echo "[sentry] Found sourcemaps: ${MAP_COUNT}"

          if [ "${MAP_COUNT}" -gt 0 ]; then
            # 1. Release 생성 (이미 존재하면 info로 확인)
            if pnpm --filter backend exec sentry-cli releases info "$SENTRY_RELEASE" --log-level=debug; then
              echo "[sentry] Release already exists: $SENTRY_RELEASE"
            else
              pnpm --filter backend exec sentry-cli releases new "$SENTRY_RELEASE" --log-level=debug
            fi

            # 2. Debug ID 주입 (Sentry v3 권장)
            pnpm --filter backend exec sentry-cli sourcemaps inject apps/backend/dist --log-level=debug

            # 3. 소스맵 업로드 (--no-ignore 옵션 추가로 .gitignore 무시)
            pnpm --filter backend exec sentry-cli sourcemaps upload --release "$SENTRY_RELEASE" apps/backend/dist --no-ignore --log-level=debug
            
            # 4. Finalize
            pnpm --filter backend exec sentry-cli releases finalize "$SENTRY_RELEASE" --log-level=debug
          else
            echo "[sentry] No sourcemaps found in apps/backend/dist. Skipping upload."
          fi

      # ----------------------------------------------------------------
      # [Frontend] Build & Upload Sourcemaps (새로 추가됨)
      # ----------------------------------------------------------------
      - name: Build Frontend (for sourcemaps)
        run: pnpm turbo run build --filter=frontend

      - name: Upload Frontend Sourcemaps to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT_FRONTEND }}
          SENTRY_RELEASE: frontend@${{ github.sha }}
        run: |
          # Vite 빌드 결과물 경로 확인 (보통 apps/frontend/dist)
          if [ ! -d "apps/frontend/dist" ]; then
            echo "[sentry] apps/frontend/dist not found. Skipping upload."
            exit 0
          fi

          # Frontend 소스맵 개수 확인
          MAP_COUNT=$(find apps/frontend/dist -name '*.map' | wc -l | tr -d ' ')
          echo "[sentry] Found sourcemaps: ${MAP_COUNT}"

          if [ "${MAP_COUNT}" -gt 0 ]; then
            # 1. Release 생성
            if pnpm --filter frontend exec sentry-cli releases info "$SENTRY_RELEASE" --log-level=debug; then
              echo "[sentry] Release already exists: $SENTRY_RELEASE"
            else
              pnpm --filter frontend exec sentry-cli releases new "$SENTRY_RELEASE" --log-level=debug
            fi

            # 2. Debug ID 주입
            pnpm --filter frontend exec sentry-cli sourcemaps inject apps/frontend/dist --log-level=debug

            # 3. 소스맵 업로드 (--no-ignore 필수)
            pnpm --filter frontend exec sentry-cli sourcemaps upload --release "$SENTRY_RELEASE" apps/frontend/dist --no-ignore --log-level=debug
            
            # 4. Finalize
            pnpm --filter frontend exec sentry-cli releases finalize "$SENTRY_RELEASE" --log-level=debug
          else
            echo "[sentry] No sourcemaps found in apps/frontend/dist. Skipping upload."
          fi

      # ----------------------------------------------------------------
      # Docker Build & Push
      # ----------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NCP Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_CR_ENDPOINT }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECRET_KEY }}

      # 빌드 전 Vite env 등록
      - name: Create Frontend .env.production
        run: echo "${{ secrets.FRONTEND_ENV }}" > .env.production

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/frontend/Dockerfile
          push: true
          tags: ${{ env.NCR_REGISTRY }}/my-frontend:latest
          build-args: |
            # 소스맵 업로드는 위에서 완료했으므로, 런타임 식별을 위한 RELEASE 버전만 주입합니다.
            # Dockerfile 내부에서는 Sentry Token이 필요 없습니다.
            VITE_SENTRY_RELEASE=frontend@${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/Dockerfile
          push: true
          tags: ${{ env.NCR_REGISTRY }}/my-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 로컬(Runner)에서 파일 생성
      - name: Create .env Files locally
        run: |
          # 1) 백엔드용 환경변수 파일 생성
          echo "${{ secrets.BACKEND_ENV }}" > .env.backend

          # 2) docker-compose 변수 치환용 .env 파일 생성 (NCP_CR_ENDPOINT)
          echo "NCP_CR_ENDPOINT=${{ secrets.NCP_CR_ENDPOINT }}" > .env

      # 2. 서버에 디렉토리 생성 (SSH)
      - name: Create Directory on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_SERVER_IP }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_SSH_PORT }}
          script: |
            mkdir -p /root/my-project

      # 3. 파일 전송 (SCP)
      # 로컬에 있는 3개 파일(.env, .env.backend, docker-compose.yml)을 서버로 전송
      - name: Copy Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.NCP_SERVER_IP }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_SSH_PORT }}
          source: 'docker-compose.yml, .env.backend, .env'
          target: '/root/my-project'
          overwrite: true

      # 4. 배포 실행 (SSH)
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_SERVER_IP }}
          username: ${{ secrets.NCP_USERNAME }}
          password: ${{ secrets.NCP_PASSWORD }}
          port: ${{ secrets.NCP_SSH_PORT }}
          script: |
            cd /root/my-project

            # NCR 로그인
            docker login ${{ secrets.NCP_CR_ENDPOINT }} -u ${{ secrets.NCP_ACCESS_KEY }} -p ${{ secrets.NCP_SECRET_KEY }}

            # 이미지 Pull
            docker-compose pull

            # 마이그레이션 실행 (컨테이너 시작 전)
            docker-compose run --rm backend npx prisma migrate deploy --config prisma.config.ts

            # 컨테이너 실행
            docker-compose up -d --remove-orphans

            # 이미지 정리
            docker image prune -f

            echo "[SUCCESS] Deployment completed successfully ✅"
